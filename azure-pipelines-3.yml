# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger: none

resources:
- repo: self

pool:
 name: Default

variables:
 dockerComposePath: '/home/azureuser/azagent/azagent/_work/1/s'

stages:
- stage: DeployToVM
  displayName: 'Deploy to VM Environment'
  jobs:
  - deployment: DeployToVM
    displayName: 'Deploy to VM'
    environment: 
     name: QA
     resourceName: QA-Server
     resourceType: virtualMachine
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DockerCompose@1
            inputs:
              containerregistrytype: 'Azure Container Registry'
              azureSubscription: 'Azure subscription Pay as you Go(1ba2ff14-c7cb-42e3-8e10-8e71d9bd27d7)'
              azureContainerRegistry: '{"loginServer":"hadii.azurecr.io", "id" : "/subscriptions/1ba2ff14-c7cb-42e3-8e10-8e71d9bd27d7/resourceGroups/Azure-Devops/providers/Microsoft.ContainerRegistry/registries/hadii"}'
              dockerComposeFile: '$(dockerComposePath)/docker-compose2.yml'
              action: 'Run a Docker Compose command'
              dockerComposeCommand: 'up -d'

